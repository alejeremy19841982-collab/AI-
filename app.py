import streamlit as st
from duckduckgo_search import DDGS
import google.generativeai as genai
import json
import datetime
import os

# --- 1. é¡µé¢é…ç½® (2026 Future Style) ---
st.set_page_config(
    page_title="AI æ¯æ—¥æƒ…æŠ¥ç«™ (Gemini 3.0)",
    page_icon="âš¡",
    layout="wide",
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰ CSS è®©ç•Œé¢æ›´ç°ä»£
st.markdown("""
    <style>
    .stButton>button {
        background-color: #FF4B4B;
        color: white;
        border-radius: 8px;
        height: 3em;
        font-weight: bold;
    }
    .report-card {
        background-color: #f0f2f6;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
    }
    </style>
""", unsafe_allow_html=True)

# --- 2. æœç´¢é€»è¾‘ (æ•°æ®æº) ---
def search_ai_news():
    """
    æœç´¢æœ€æ–°çš„ AI èµ„è®¯ï¼Œå¢åŠ æƒé‡ä»¥è·å–å·¥å…·å’Œå•†ä¸šæ–°é—»
    """
    # 2026å¹´çš„æœç´¢è¯ç­–ç•¥ï¼šæ›´æ³¨é‡ 'Launch', 'Release', 'Startup'
    query = "Artificial Intelligence news latest 24 hours new AI model release startup funding breaking"
    results = []
    
    try:
        with DDGS() as ddgs:
            # è·å– 12 æ¡ç»“æœï¼Œå–‚ç»™ Gemini 3.0 çš„å¤§çª—å£
            ddgs_gen = ddgs.text(query, region='wt-wt', safesearch='off', max_results=12)
            for r in ddgs_gen:
                results.append(r)
    except Exception as e:
        st.error(f"âŒ æœç´¢ç½‘ç»œå±‚é”™è¯¯: {e}")
        return None

    if not results:
        return None
        
    # æ ¼å¼åŒ–ä¸Šä¸‹æ–‡
    context_text = ""
    for idx, item in enumerate(results):
        context_text += f"--- News Item {idx+1} ---\nTitle: {item.get('title')}\nSnippet: {item.get('body')}\nLink: {item.get('href')}\n"
    
    return context_text

# --- 3. Gemini 3.0 å¤„ç†é€»è¾‘ (æ ¸å¿ƒå¤§è„‘) ---
def process_news_with_gemini(api_key, raw_data, model_name):
    """
    è°ƒç”¨ Google Gemini 3.0 API è¿›è¡Œå¤„ç†
    """
    if not api_key:
        st.error("âŒ æœªæ£€æµ‹åˆ° API Key")
        return None

    try:
        genai.configure(api_key=api_key)
    except Exception as e:
        st.error(f"API Key è®¤è¯å¤±è´¥: {e}")
        return None
    
    # é…ç½®ç”Ÿæˆå‚æ•°ï¼šå¼ºåˆ¶ JSON
    generation_config = {
        "temperature": 0.4, # é™ä½æ¸©åº¦ä»¥è·å¾—æ›´å‡†ç¡®çš„æ–°é—»äº‹å®
        "response_mime_type": "application/json", 
    }

    try:
        model = genai.GenerativeModel(model_name, generation_config=generation_config)
    except Exception:
        st.warning(f"âš ï¸ æ¨¡å‹ {model_name} åˆå§‹åŒ–å¼‚å¸¸ï¼Œå°è¯•å›é€€åˆ° gemini-2.0-flash-exp")
        model = genai.GenerativeModel("gemini-2.0-flash-exp", generation_config=generation_config)

    # System Prompt: å®šä¹‰è§’è‰²ä¸è¾“å‡ºæ ¼å¼
    system_prompt = """
    You are a Senior AI Analyst for a top-tier Chinese tech investment firm.
    
    Your Task:
    1. Analyze the provided English search results about Artificial Intelligence.
    2. Filter out irrelevant or low-quality noise.
    3. Synthesize the information into a structured Daily Briefing in Simplified Chinese (ç®€ä½“ä¸­æ–‡).
    
    Data Extraction Rules:
    - Translate all titles and summaries into professional Chinese.
    - Identify direct business implications.
    - Extract specific names of new tools or models.

    Output Schema (Strict JSON):
    {
        "breaking_news": [
            {"title": "Chinese Title", "summary": "Core update in <50 words", "url": "Original URL", "source": "Source Name (e.g. TechCrunch)"}
        ],
        "business_trends": [
            {"trend": "Brief title of the trend", "analysis": "Why this matters for money/business in Chinese"}
        ],
        "new_tools": [
            {"name": "Tool Name (English)", "function": "What it does (Chinese)", "target_user": "Who is it for?"}
        ]
    }
    """

    user_input = f"Here is the raw news data from the last 24 hours:\n{raw_data}"

    try:
        # Gemini 3.0 è°ƒç”¨
        response = model.generate_content(system_prompt + "\n\n" + user_input)
        return response.text
    except Exception as e:
        st.error(f"âŒ Gemini æ¨ç†å¤±è´¥: {e}")
        return None

# --- 4. å‰ç«¯ç•Œé¢æ¸²æŸ“ ---
def main():
    # ä¾§è¾¹æ 
    with st.sidebar:
        st.title("âš™ï¸ æ§åˆ¶å°")
        
        api_key = st.text_input("Google AI Studio Key", type="password", placeholder="AIza...")
        
        # 2026å¹´ æ¨¡å‹åˆ—è¡¨ (å‡è®¾åç§°)
        model_choice = st.selectbox(
            "é€‰æ‹©æ¨ç†å¼•æ“", 
            [
                "gemini-3.0-flash",   # å‡è®¾çš„ V3 Flash
                "gemini-3.0-pro",     # å‡è®¾çš„ V3 Pro
                "gemini-2.0-flash-exp", # ç°å®ä¸­å¯ç”¨çš„ fallback
                "gemini-1.5-pro-latest" # ç»å…¸æ¬¾
            ],
            index=0
        )
        
        if "3.0" in model_choice:
            st.success("ğŸš€ å·²æ¿€æ´» Next-Gen æ¶æ„")
        
        st.divider()
        st.caption("Auto-generated by Streamlit & Gemini")
        run_btn = st.button("å¼€å§‹ç”Ÿæˆæƒ…æŠ¥ (Generate)", use_container_width=True)

    # ä¸»åŒºåŸŸ
    st.title("âš¡ AI æ¯æ—¥æƒ…æŠ¥ç«™")
    st.markdown(f"**æ—¥æœŸ**: {datetime.date.today().strftime('%Yå¹´%mæœˆ%dæ—¥')} | **å¼•æ“**: DuckDuckGo + {model_choice}")
    
    if run_btn:
        if not api_key:
            st.warning("âš ï¸ è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥ API Key")
            return

        # æ­¥éª¤ 1: æœç´¢
        with st.status("ğŸ“¡ æ­£åœ¨è¿æ¥å…¨çƒèµ„è®¯ç½‘ç»œ...", expanded=True) as status:
            status.write("ğŸ” æ­£åœ¨æ£€ç´¢ DuckDuckGo (Last 24h)...")
            raw_news = search_ai_news()
            
            if not raw_news:
                status.update(label="âŒ æœç´¢æ— ç»“æœæˆ–ç½‘ç»œè¶…æ—¶", state="error")
                return
            
            # æ­¥éª¤ 2: æ¨ç†
            status.write(f"ğŸ§  æ­£åœ¨ä¸Šä¼ è‡³ {model_choice} è¿›è¡Œè¯­ä¹‰åˆ†æ...")
            json_result = process_news_with_gemini(api_key, raw_news, model_choice)
            
            if not json_result:
                status.update(label="âŒ æ¨¡å‹ç”Ÿæˆå¤±è´¥", state="error")
                return
                
            status.update(label="âœ… æƒ…æŠ¥æ„å»ºå®Œæˆï¼", state="complete", expanded=False)

        # æ­¥éª¤ 3: å±•ç¤º
        try:
            data = json.loads(json_result)
            
            # æ¿å— 1: æ ¸å¿ƒæ–°é—»
            st.subheader("ğŸš¨ å…¨çƒæ ¸å¿ƒåŠ¨æ€ (Breaking)")
            for news in data.get("breaking_news", []):
                with st.expander(f"ğŸ“° {news['title']}", expanded=True):
                    st.markdown(f"**æ‘˜è¦**: {news['summary']}")
                    if 'source' in news:
                        st.caption(f"æ¥æº: {news['source']}")
                    st.markdown(f"[ğŸ”— ç‚¹å‡»é˜…è¯»åŸæ–‡]({news['url']})")
            
            st.divider()
            
            # æ¿å— 2 & 3: å¹¶åˆ—å¸ƒå±€
            col1, col2 = st.columns([1, 1])
            
            with col1:
                st.subheader("ğŸ’° å•†ä¸šé£å‘æ ‡")
                for item in data.get("business_trends", []):
                    st.info(f"**{item['trend']}**\n\n{item['analysis']}")
            
            with col2:
                st.subheader("ğŸ› ï¸ æå®¢æ–°å·¥å…·")
                for tool in data.get("new_tools", []):
                    with st.container(border=True):
                        st.markdown(f"**ğŸš€ {tool['name']}**")
                        st.markdown(f"åŠŸèƒ½: {tool['function']}")
                        st.caption(f"é€‚ç”¨äººç¾¤: {tool['target_user']}")

        except json.JSONDecodeError:
            st.error("âŒ æ•°æ®è§£æå¤±è´¥ã€‚æ¨¡å‹è¿”å›äº†éæ ‡å‡† JSONã€‚")
            with st.expander("æŸ¥çœ‹åŸå§‹è¿”å›"):
                st.code(json_result)

if __name__ == "__main__":
    main()
